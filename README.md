# Функциональные требования к приложению "Тарология"

## 1. Общие требования

**ФТ 1.1 Идентификация пользователя:** Система должна позволять пользователям взаимодействовать с ней без регистрации и входа. Каждый пользователь идентифицируется по уникальному ID, который он предоставляет при совершении действий.

## 2. Управление Раскладами Таро

### ФТ 2.1 Создание нового расклада

- Пользователь должен иметь возможность запросить новый расклад Таро.
- Для создания расклада пользователь должен предоставить свой ID, текстовый вопрос и выбрать схему расклада.
- Система должна поддерживать минимум три схемы расклада:
  - Одна карта
  - Тройка (три карты)
  - Крест (пять карт)
- Система должна автоматически сгенерировать результат расклада (набор карт) в ответ на запрос пользователя согласно выбранной схеме.
- Созданный расклад (вопрос, схема и выпавшие карты) должен быть сохранен в системе и доступен для просмотра.

### ФТ 2.2 Просмотр списка всех раскладов

- Пользователь должен иметь возможность просматривать общую ленту всех раскладов, созданных в системе всеми пользователями.
- Расклады в ленте должны быть отсортированы в хронологическом порядке (от самых новых к самым старым).
- В списке для каждого расклада должна отображаться краткая информация, как минимум — текст вопроса.

### ФТ 2.3 Просмотр детальной информации о раскладе

Пользователь должен иметь возможность открыть любой расклад из списка для детального просмотра.

На странице детального просмотра должна отображаться следующая информация:
- Исходный вопрос, заданный пользователем.
- ID пользователя, создавшего расклад.
- Названия выпавших карт.
- Все текстовые интерпретации, добавленные другими пользователями к этому раскладу.

### ФТ 2.4 Удаление расклада

- Пользователь должен иметь возможность удалить созданный им расклад.
- При удалении расклада должны быть удалены все связанные с ним интерпретации.
- Система должна проверять, что пользователь удаляет только свой собственный расклад.

## 3. Управление Интерпретациями

### ФТ 3.1 Добавление интерпретации к раскладу

- Любой пользователь должен иметь возможность добавить свою текстовую интерпретацию (толкование) к любому существующему раскладу.
- Несколько разных пользователей могут добавлять интерпретации к одному раскладу.
- Один пользователь может иметь только одну интерпретацию на каждый расклад (но может ее редактировать).
- Для добавления интерпретации пользователь должен предоставить свой ID и текст.
- После добавления интерпретация должна отображаться в списке всех интерпретаций на странице детального просмотра соответствующего расклада.

### ФТ 3.2 Редактирование собственной интерпретации

- Пользователь должен иметь возможность изменить текст ранее добавленной им интерпретации.
- Система должна проверять, что пользователь редактирует только свою собственную интерпретацию, а не чужую.

### ФТ 3.3 Удаление собственной интерпретации

- Пользователь должен иметь возможность удалить свою интерпретацию.
- Система должна проверять, что пользователь удаляет только свою собственную интерпретацию.

## 4. Управление пользователями

### ФТ 4.1 Удаление пользователя и всех его данных

- Система должна поддерживать транзакционное удаление пользователя вместе со всеми его данными.
- При удалении пользователя должны быть удалены:
  - Все расклады, созданные этим пользователем
  - Все интерпретации к этим раскладам от других пользователей
  - Все интерпретации этого пользователя к чужим раскладам
- Вся операция должна выполняться в рамках одной транзакции для обеспечения целостности данных.

## Модель данных и структура БД

Будут созданы следующие JPA-сущности (Entity):

### User (Пользователь)
- `id` (Long, Primary Key)

### Spread (Расклад)
- `id` (Long, Primary Key)
- `question` (String, валидация на непустое значение)
- `layoutType` (String, Enum: ONE_CARD/THREE_CARDS/CROSS)
- `createdAt` (Timestamp)
- **Связь (Many-to-One):** `author_id` — ссылка на автора расклада.

### Interpretation (Интерпретация)
- `id` (Long, Primary Key)
- `text` (String, валидация на размер и содержание)
- `createdAt` (Timestamp)
- **Связь (Many-to-One):** `author_id` — автор интерпретации.
- **Связь (Many-to-One):** `spread_id` — расклад, к которому относится интерпретация.
- **Уникальное ограничение:** комбинация `author_id` + `spread_id` должна быть уникальной (один пользователь - одна интерпретация на расклад).

### Card (Карта Таро)
- `id` (Integer, Primary Key)
- `name` (String)
- `arcanaType` (String, Enum: MAJOR/MINOR)
- **Примечание:** Эта таблица будет заполнена 78 картами через Liquibase миграцию как справочник.

### SpreadCard (Карта в Раскладе)

Это ассоциативная сущность для реализации связи Many-to-Many с дополнительным полем между Spread и Card.

- `id` (Long, Primary Key)
- **Связь (Many-to-One):** `spread_id` — расклад, к которому относится карта.
- **Связь (Many-to-One):** `card_id` — карта, которая выпала в раскладе.
- **Дополнительные поля:**
  - `positionInSpread` (Integer): Позиция карты в раскладе (1, 2, 3...).
  - `isReversed` (Boolean): Флаг, указывающий, была ли карта перевернута.

## Реализация связей между сущностями (согласно требованиям)

### One-to-Many / Many-to-One:
- User ↔ Spread (Один пользователь может создать много раскладов).
- User ↔ Interpretation (Один пользователь может написать много интерпретаций).
- Spread ↔ Interpretation (Один расклад может иметь много интерпретаций).

### Many-to-Many с дополнительным полем:
- Spread ↔ Card. Чтобы смоделировать, какие карты выпали в конкретном раскладе, создается связующая таблица `spread_cards`.
- Дополнительные поля в этой таблице:
  - `position`: INTEGER (позиция карты в раскладе: 1, 2, 3 и т.д.).
  - `is_reversed`: BOOLEAN (была ли карта перевернута).

## Спецификация API (API Layer)

### Ресурс: Расклады (`/api/spreads`)

#### POST /api/spreads
- **Назначение:** Создать новый расклад.
- **Тело запроса:** `{ "userId": number, "question": "string", "layoutType": "ONE_CARD|THREE_CARDS|CROSS" }`
- **Успешный ответ:** 201 Created с JSON-объектом созданного расклада.

#### GET /api/spreads
- **Назначение:** Получить постраничный список всех раскладов.
- **Параметры запроса:** `?page=<номер_страницы>&size=<размер_страницы>`
- **Успешный ответ:** 200 OK с JSON-массивом раскладов. В HTTP-заголовке ответа должен присутствовать X-Total-Count с общим количеством записей.

#### GET /api/spreads/scroll
- **Назначение:** Получить следующую порцию раскладов для "бесконечной прокрутки".
- **Параметры запроса:** 
  - `after=<id>` - ID расклада, после которого нужно получить следующие записи (опционально)
  - `size=<размер_страницы>` - количество записей для получения
- **Успешный ответ:** 200 OK с JSON-массивом раскладов.
- **Примечание:** Если параметр `after` не указан, возвращаются самые новые расклады.

#### GET /api/spreads/{id}
- **Назначение:** Получить детальную информацию о конкретном раскладе.
- **Параметр пути:** id (идентификатор расклада).
- **Успешный ответ:** 200 OK с JSON-объектом расклада.
- **Ответ в случае ошибки:** 404 Not Found, если расклад не найден.

#### DELETE /api/spreads/{id}
- **Назначение:** Удалить расклад.
- **Параметр пути:** id (идентификатор расклада).
- **Тело запроса:** `{ "userId": number }`
- **Успешный ответ:** 204 No Content (без тела ответа).
- **Ответ в случае ошибки:** 403 Forbidden, если пользователь пытается удалить чужой расклад.

### Ресурс: Интерпретации (`/api/spreads/{spreadId}/interpretations`)

#### POST /api/spreads/{spreadId}/interpretations
- **Назначение:** Добавить новую интерпретацию к существующему раскладу.
- **Параметр пути:** spreadId (идентификатор расклада).
- **Тело запроса:** `{ "userId": number, "text": "string" }`
- **Успешный ответ:** 201 Created с JSON-объектом созданной интерпретации.
- **Ответ в случае ошибки:** 409 Conflict, если пользователь уже имеет интерпретацию к этому раскладу.

#### PUT /api/spreads/{spreadId}/interpretations/{id}
- **Назначение:** Обновить текст существующей интерпретации.
- **Параметры пути:** 
  - spreadId (идентификатор расклада)
  - id (идентификатор интерпретации)
- **Тело запроса:** `{ "userId": number, "text": "string" }`
- **Успешный ответ:** 200 OK с JSON-объектом обновленной интерпретации.
- **Ответ в случае ошибки:** 403 Forbidden, если пользователь пытается редактировать чужую интерпретацию.

#### DELETE /api/spreads/{spreadId}/interpretations/{id}
- **Назначение:** Удалить интерпретацию.
- **Параметры пути:** 
  - spreadId (идентификатор расклада)
  - id (идентификатор интерпретации)
- **Тело запроса:** `{ "userId": number }`
- **Успешный ответ:** 204 No Content (без тела ответа).
- **Ответ в случае ошибки:** 403 Forbidden, если пользователь пытается удалить чужую интерпретацию.

### Ресурс: Пользователи (`/api/users`)

#### DELETE /api/users/{id}
- **Назначение:** Удалить пользователя и все связанные с ним данные.
- **Параметр пути:** id (идентификатор пользователя).
- **Успешный ответ:** 204 No Content (без тела ответа).
- **Примечание:** Операция удаляет все расклады и интерпретации пользователя в рамках одной транзакции.

## Бизнес-логика (Service Layer)

### Процессы для "Раскладов"

#### Создание нового расклада:
1. Получив `userId`, `question` и `layoutType`, система создает новую запись Spread.
2. В зависимости от выбранной схемы (layoutType) генерируется соответствующее количество случайных карт:
   - ONE_CARD: 1 карта
   - THREE_CARDS: 3 карты
   - CROSS: 5 карт
3. В связующей таблице сохраняются ID расклада, ID каждой выпавшей карты и ее атрибуты (позиция в раскладе, перевернута или нет).
4. **Правило:** Вся операция (пункты 1-3) должна выполняться в рамках одной транзакции. Если любая часть процесса завершается ошибкой, все изменения в базе данных отменяются (rollback).

#### Получение списка раскладов:
- Система запрашивает из базы данных список раскладов, отсортированный по дате создания (от новых к старым).
- Для эндпоинта `/api/spreads` дополнительно выполняется запрос на получение общего количества записей в таблице.

#### Получение одного расклада:
- Система извлекает из базы данных запрошенный расклад, а также все связанные с ним карты и все связанные интерпретации.

#### Удаление расклада:
1. Система проверяет, что `userId` из запроса совпадает с `userId` автора расклада.
2. Удаляются все интерпретации, связанные с раскладом.
3. Удаляются все записи о картах в раскладе из таблицы SpreadCard.
4. Удаляется сам расклад.
5. **Правило:** Вся операция должна выполняться в рамках одной транзакции.

### Процессы для "Интерпретаций"

#### Добавление интерпретации:
1. Система проверяет, что расклад с указанным `spreadId` существует.
2. Система проверяет, что у пользователя еще нет интерпретации к этому раскладу (проверка уникальности по комбинации `userId` + `spreadId`).
3. Если проверка пройдена, создается новая запись Interpretation, которая связывается с ID расклада и ID пользователя-автора.
4. Если у пользователя уже есть интерпретация к этому раскладу, возвращается ошибка 409 Conflict.

#### Редактирование интерпретации:
- **Правило:** Перед обновлением текста интерпретации система должна убедиться, что `userId` из запроса совпадает с `userId` автора, который изначально создал эту интерпретацию.

#### Удаление интерпретации:
- **Правило:** Перед удалением система должна убедиться, что `userId` из запроса совпадает с `userId` автора интерпретации.

### Процессы для "Пользователей"

#### Удаление пользователя и всех его данных:
1. Система находит все расклады, созданные пользователем.
2. Для каждого расклада:
   - Удаляются все интерпретации других пользователей
   - Удаляются все записи о картах из таблицы SpreadCard
   - Удаляется сам расклад
3. Удаляются все интерпретации этого пользователя к чужим раскладам.
4. Удаляется запись пользователя.
5. **Правило:** Вся операция должна выполняться в рамках одной транзакции для обеспечения целостности данных.